<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitar Serviço - Construjá</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="flex items-center">
                        <i data-feather="tool" class="text-primary h-8 w-8"></i>
                        <span class="ml-2 text-xl font-bold text-gray-800">Construjá</span>
                    </a>
                </div>
                
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="text-gray-800 hover:text-primary font-medium">Home</a>
                    <a href="profissionais.html" class="text-gray-800 hover:text-primary font-medium">Profissionais</a>
                </div>
                
                <div class="flex items-center space-x-4" id="userMenu">
                    <!-- Menu será carregado via JS -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Solicitar Serviço</h1>
                <p class="text-gray-600">Descreva o serviço que você precisa e encontre os melhores profissionais</p>
            </div>

            <!-- Service Form -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <form id="serviceRequestForm" onsubmit="submitServiceRequest(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Tipo de Serviço -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Serviço *</label>
                            <select id="tipoServico" required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="">Selecione o tipo de serviço</option>
                                <option value="alvenaria">Alvenaria</option>
                                <option value="pintura">Pintura</option>
                                <option value="eletrica">Instalação Elétrica</option>
                                <option value="hidraulica">Instalação Hidráulica</option>
                                <option value="revestimento">Revestimento</option>
                                <option value="reforma">Reforma</option>
                                <option value="construcao">Construção</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>

                        <!-- Título -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Título do Serviço *</label>
                            <input type="text" id="tituloServico" required 
                                   placeholder="Ex: Pintura da sala e quartos"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>

                        <!-- Descrição -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descrição Detalhada *</label>
                            <textarea id="descricaoServico" required rows="5"
                                      placeholder="Descreva em detalhes o serviço que precisa. Inclua medidas, materiais, prazos desejados e qualquer informação relevante."
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                        </div>

                        <!-- Endereço -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Local do Serviço *</label>
                            <input type="text" id="enderecoServico" required 
                                   placeholder="Endereço completo onde o serviço será realizado"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>

                        <!-- Orçamento Previsto -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Orçamento Previsto (opcional)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500">R$</span>
                                <input type="number" id="orcamentoPrevisto" step="0.01" min="0"
                                       placeholder="0,00"
                                       class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                        </div>

                        <!-- Urgência -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Urgência</label>
                            <select id="urgenciaServico"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="baixa">Baixa (1-2 semanas)</option>
                                <option value="media" selected>Média (3-7 dias)</option>
                                <option value="alta">Alta (1-2 dias)</option>
                            </select>
                        </div>

                        <!-- Profissional Específico -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Profissional Específico (opcional)</label>
                            <select id="profissionalEspecifico"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="">Enviar para todos os profissionais disponíveis</option>
                                <!-- Profissionais serão carregados via JS -->
                            </select>
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 mt-8 pt-6 border-t border-gray-200">
                        <button type="submit" 
                                class="flex-1 bg-primary text-white py-3 px-6 rounded-md hover:bg-blue-600 transition duration-300 font-medium">
                            <i data-feather="send" class="w-4 h-4 inline mr-2"></i>
                            Enviar Solicitação
                        </button>
                        <a href="profissionais.html" 
                           class="flex-1 bg-gray-300 text-gray-700 py-3 px-6 rounded-md hover:bg-gray-400 transition duration-300 font-medium text-center">
                            <i data-feather="search" class="w-4 h-4 inline mr-2"></i>
                            Buscar Profissionais
                        </a>
                    </div>
                </form>
            </div>

            <!-- How it Works -->
            <div class="mt-12">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Como Funciona</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center p-6 bg-white rounded-lg shadow-md">
                        <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-feather="edit-3" class="text-primary w-6 h-6"></i>
                        </div>
                        <h3 class="font-semibold mb-2">1. Descreva o Serviço</h3>
                        <p class="text-gray-600 text-sm">Forneça detalhes sobre o que você precisa</p>
                    </div>
                    <div class="text-center p-6 bg-white rounded-lg shadow-md">
                        <div class="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-feather="users" class="text-secondary w-6 h-6"></i>
                        </div>
                        <h3 class="font-semibold mb-2">2. Receba Propostas</h3>
                        <p class="text-gray-600 text-sm">Profissionais interessados enviarão orçamentos</p>
                    </div>
                    <div class="text-center p-6 bg-white rounded-lg shadow-md">
                        <div class="bg-yellow-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-feather="check-circle" class="text-yellow-500 w-6 h-6"></i>
                        </div>
                        <h3 class="font-semibold mb-2">3. Escolha o Melhor</h3>
                        <p class="text-gray-600 text-sm">Selecione o profissional ideal para seu projeto</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Configuração do Supabase
        const supabaseUrl = 'https://ocvkhwtbmpiltjbttsko.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jdmtod3RibXBpbHRqYnR0c2tvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzE5MzgsImV4cCI6MjA3OTg0NzkzOH0.Y6KFqQxs9l2fDziiURjtW3oZr6MWKZPNtyhT5-K7yGw';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;

        // Inicializar página
        async function initializePage() {
            await checkAuth();
            await loadProfessionals();
            setupEventListeners();
        }

        // Verificar autenticação
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                const { data: usuario } = await supabase
                    .from('usuarios')
                    .select('nome, tipo')
                    .eq('id', user.id)
                    .single();
                
                currentUser = usuario;
                updateUserMenu(usuario);

                // Verificar se é cliente
                if (usuario.tipo !== 'cliente') {
                    alert('Apenas clientes podem solicitar serviços.');
                    window.location.href = 'professional/index.html';
                }
            } else {
                alert('Por favor, faça login para solicitar um serviço.');
                window.location.href = 'auth/login.html';
            }
        }

        // Atualizar menu do usuário
        function updateUserMenu(usuario) {
            const userMenu = document.getElementById('userMenu');
            
            if (usuario) {
                userMenu.innerHTML = `
                    <div class="relative group">
                        <button class="flex items-center space-x-2 text-gray-800 hover:text-primary">
                            <i data-feather="user" class="w-5 h-5"></i>
                            <span>${usuario.nome}</span>
                            <i data-feather="chevron-down" class="w-4 h-4"></i>
                        </button>
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden group-hover:block z-50">
                            <a href="cliente/dashboard.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Dashboard</a>
                            <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sair</a>
                        </div>
                    </div>
                `;
            }
            feather.replace();
        }

        // Carregar profissionais para seleção específica
        async function loadProfessionals() {
            const { data: professionals, error } = await supabase
                .from('profissionais')
                .select(`
                    id,
                    especialidade,
                    usuario:usuarios!inner(nome)
                `)
                .eq('disponivel', true);

            if (error) {
                console.error('Erro ao carregar profissionais:', error);
                return;
            }

            const select = document.getElementById('profissionalEspecifico');
            professionals.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof.id;
                option.textContent = `${prof.usuario.nome} - ${prof.especialidade}`;
                select.appendChild(option);
            });
        }

        // Enviar solicitação de serviço
        async function submitServiceRequest(event) {
            event.preventDefault();

            if (!currentUser) {
                alert('Por favor, faça login para continuar.');
                return;
            }

            const formData = {
                cliente_id: currentUser.id,
                titulo: document.getElementById('tituloServico').value,
                descricao: document.getElementById('descricaoServico').value,
                tipo_servico: document.getElementById('tipoServico').value,
                endereco_servico: document.getElementById('enderecoServico').value,
                orcamento: document.getElementById('orcamentoPrevisto').value || null,
                profissional_id: document.getElementById('profissionalEspecifico').value || null,
                status: 'solicitado'
            };

            try {
                const { data: servico, error } = await supabase
                    .from('servicos')
                    .insert([formData])
                    .select()
                    .single();

                if (error) throw error;

                alert('Solicitação enviada com sucesso! Os profissionais entrarão em contato em breve.');
                
                // Redirecionar para dashboard
                window.location.href = 'cliente/dashboard.html';

            } catch (error) {
                console.error('Erro ao enviar solicitação:', error);
                alert('Erro ao enviar solicitação. Tente novamente.');
            }
        }

        // Logout
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'auth/login.html';
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Validação em tempo real
            document.getElementById('tipoServico').addEventListener('change', function() {
                if (this.value === 'outro') {
                    document.getElementById('tituloServico').placeholder = 'Especifique o tipo de serviço...';
                }
            });
        }

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>